# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/introduction/learn-gitpod/gitpod-yaml)
# and commit this file to your remote git repository to share the goodness with others.

# Learn more from ready-to-use templates: https://www.gitpod.io/docs/introduction/getting-started/quickstart

tasks:
  - name: Postgres
    command: |
      sudo apt-get update
      sudo apt-get install postgresql postgresql-contrib -y
      sudo apt-get install libpq-dev -y
      docker run --rm --name postgres -e POSTGRES_PASSWORD=postgres -p 5432:5432 postgres

  - name: Server
    command: |
      cp .env.example .env
      echo "TOOLJET_HOST=$(gp url 3000)" >> .env
      echo "PG_HOST=127.0.0.1" >> .env
      echo "PG_PORT=5432" >> .env
      echo "PG_USER=postgres" >> .env
      echo "PG_PASS=postgres" >> .env
      echo "PG_DB=tooljet_development" >> .env

      pyenv install 3.10
      pyenv global 3.10
      
      nvm install 18.3.0
      npm install
      npm install --prefix server
      npm install --prefix frontend

      npm run build:plugins
      npm run build:frontend
      npm run build:server

      npm run --prefix server db:reset

      cd ./server 
      NODE_ENV=production npm run start

  - name: Frontend
    command: |
      gp await-port 3000
      cd ./frontend 
      npm start